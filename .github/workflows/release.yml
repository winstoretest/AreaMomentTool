name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  SOLUTION_FILE: AreaMomentTool.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: nuget/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}

    - name: Build solution
      run: msbuild ${{ env.SOLUTION_FILE }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ env.BUILD_PLATFORM }}

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi

    - name: Update ISS version
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $content = Get-Content -Path "AreaMomentTool.iss" -Raw
        $content = $content -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`""
        Set-Content -Path "AreaMomentTool.iss" -Value $content

    - name: Build installer
      uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
      with:
        path: AreaMomentTool.iss
        options: /O".\installer"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AreaMomentTool-${{ steps.get_version.outputs.VERSION }}
        path: |
          x64/Release/AreaMomentTool.dll
          AreaMomentTool.adc
          AreaMomentTool.ico
          installer/*.exe

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: AreaMomentTool v${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: |
          installer/*.exe
        body: |
          ## AreaMomentTool v${{ steps.get_version.outputs.VERSION }}

          ### Installation
          1. Download and run the installer below
          2. Follow the installation wizard
          3. Restart Alibre Design if it's running

          ### Requirements
          - Alibre Design (must be installed before running the installer)
          - Windows 10/11 x64
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
